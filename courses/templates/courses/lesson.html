{% extends "core/base_public.html" %}
{% load static %}

{% block title %}{{ lesson.title }} - {{ course.title }}{% endblock %}

{% block extra_css %}
<style>
    .lesson-sidebar {
        height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .mcq-card {
        border-left: 4px solid var(--bs-primary);
    }
    
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 min-vh-100">
    <div class="row g-4">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Video Player -->
            <div class="video-container-native lesson-mode shadow-lg mb-4" id="video-wrapper">
                {% if lesson.youtube_video_id %}

                <!-- Custom Play Button Overlay -->
                <div class="custom-play-overlay" id="customPlayOverlay">
                    <div class="play-button-circle">
                        <div class="play-icon"></div>
                    </div>
                    <div class="play-overlay-text">Start Lesson</div>
                </div>

                <!-- Loading State -->
                <div class="video-loading" id="videoLoading">
                    <div class="loading-spinner"></div>
                </div>

                <!-- Extended Interaction Mask (80px) -->
                <div class="video-mask-top-extended" title="Video Protected"></div>

                <div id="player"></div>

                <div id="video-error" class="video-error-native d-none">
                    <i class="fas fa-exclamation-circle"></i>
                    <h5>Video Unavailable</h5>
                    <p>We're unable to play this video right now. It may have been removed or is restricted.</p>
                </div>
                {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-white">
                    <p>No video available for this lesson.</p>
                </div>
                {% endif %}
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold mb-0">{{ lesson.title }}</h2>
                <form action="{% url 'courses:mark_lesson_complete' course.slug lesson.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">
                        <i class="fas fa-check-circle me-2"></i> Mark as Completed
                    </button>
                </form>
            </div>

            <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
                <h5 class="fw-bold mb-3">About this Lesson</h5>
                <p class="text-muted">{{ lesson.description|default:"No description provided." }}</p>

                {% if resources %}
                <hr>
                <h6 class="fw-bold mb-3">Supporting Resources</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for res in resources %}
                    <a href="{{ res.get_resource_url }}" target="_blank"
                        class="btn btn-light btn-sm rounded-pill border">
                        <i
                            class="{% if res.resource_type == 'pdf' %}far fa-file-pdf text-danger{% else %}fas fa-link text-info{% endif %} me-1"></i>
                        {{ res.title }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- MCQs Section -->
            {% if mcq_questions %}
            <div class="mt-5">
                <h3 class="fw-bold mb-4">Lesson Assessment</h3>
                {% for q in mcq_questions %}
                <div class="card mcq-card border-0 shadow-sm rounded-4 p-4 mb-3" id="q{{ q.id }}">
                    <p class="fw-bold mb-3">{{ forloop.counter }}. {{ q.question_text }}</p>
                    <div class="row g-2">

                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100 text-start py-3 px-4 rounded-3 mcq-opt"
                                data-q="{{ q.id }}" data-opt="A">A. {{ q.option_a }}</button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100 text-start py-3 px-4 rounded-3 mcq-opt"
                                data-q="{{ q.id }}" data-opt="B">B. {{ q.option_b }}</button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100 text-start py-3 px-4 rounded-3 mcq-opt"
                                data-q="{{ q.id }}" data-opt="C">C. {{ q.option_c }}</button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100 text-start py-3 px-4 rounded-3 mcq-opt"
                                data-q="{{ q.id }}" data-opt="D">D. {{ q.option_d }}</button>
                        </div>
                    </div>
                    <div class="mt-3 feedback-box d-none">
                        <div class="alert mb-0 small"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar: Lesson List -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 lesson-sidebar">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="mb-0 fw-bold">Course Curriculum</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for l in all_lessons %}
                    <a href="{% url 'courses:lesson_view' course.slug l.id %}"
                        class="list-group-item list-group-item-action py-3 border-0 {% if l.id == lesson.id %}bg-primary-subtle text-primary fw-bold{% endif %}">
                        <div class="d-flex align-items-center">
                            <i
                                class="fas {% if l.id == lesson.id %}fa-play-circle{% else %}fa-check-circle text-muted{% endif %} me-3"></i>
                            <div>
                                <small class="d-block text-muted ls-1">LESSON {{ l.order }}</small>
                                <span>{{ l.title }}</span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Video Security Deterrents
    const videoWrapper = document.getElementById('video-wrapper');
    if (videoWrapper) {
        videoWrapper.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            // Optional: show a subtle toast instead of alert
        });
    }

    // YouTube IFrame API
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    var playerReady = false;

    function onYouTubeIframeAPIReady() {
        if ("{{ lesson.youtube_video_id|escapejs }}") {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: '{{ lesson.youtube_video_id|escapejs }}',
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1,
                    'enablejsapi': 1,
                    'origin': window.location.origin,
                    'fs': 1,
                    'iv_load_policy': 3,
                    'cc_load_policy': 0,
                    'disablekb': 0
                },
                events: {
                    'onReady': onPlayerReady,
                    'onError': onPlayerError,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
    }

    function onPlayerReady(event) {
        playerReady = true;
        // Hide loading spinner
        const loadingEl = document.getElementById('videoLoading');
        if (loadingEl) {
            loadingEl.classList.add('hidden');
        }
    }

    function onPlayerStateChange(event) {
        // Hide custom overlay when video starts playing
        if (event.data === YT.PlayerState.PLAYING) {
            const overlay = document.getElementById('customPlayOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }
    }

    function onPlayerError(event) {
        // Errors: 2 (invalid param), 5 (HTML5 error), 100 (not found/removed), 101/150 (not embeddable)
        console.error("YouTube Player Error:", event.data);
        const errorBox = document.getElementById('video-error');
        const playerEl = document.getElementById('player');
        const overlay = document.getElementById('customPlayOverlay');
        const loading = document.getElementById('videoLoading');

        if (errorBox && playerEl) {
            errorBox.classList.remove('d-none');
            playerEl.classList.add('d-none');
            if (overlay) overlay.classList.add('hidden');
            if (loading) loading.classList.add('hidden');
        }
    }

    // Custom Play Button Handler
    document.addEventListener('DOMContentLoaded', function () {
        const playOverlay = document.getElementById('customPlayOverlay');
        if (playOverlay && "{{ lesson.youtube_video_id|escapejs }}") {
            playOverlay.addEventListener('click', function () {
                if (playerReady && player) {
                    player.playVideo();
                    this.classList.add('hidden');
                }
            });
        }

        // MCQ Submission Logic
        document.querySelectorAll('.mcq-opt').forEach(btn => {
            btn.addEventListener('click', function () {
                const qId = this.dataset.q;
                const opt = this.dataset.opt;
                const card = document.getElementById('q' + qId);
                const feedback = card.querySelector('.feedback-box');
                const alertDiv = feedback.querySelector('.alert');

                // Disable all options for this question
                card.querySelectorAll('.mcq-opt').forEach(b => b.classList.add('disabled'));

                // Submit via Ajax
                const formData = new FormData();
                formData.append('option', opt);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch(`/courses/{{ course.slug }}/lesson/{{ lesson.id }}/mcq/${qId}/submit/`, {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        feedback.classList.remove('d-none');
                        if (data.is_correct) {
                            this.classList.replace('btn-outline-primary', 'btn-success');
                            alertDiv.className = 'alert alert-success mb-0 small';
                            alertDiv.innerHTML = '<strong>Correct!</strong> Well done.';
                        } else {
                            this.classList.replace('btn-outline-primary', 'btn-danger');
                            alertDiv.className = 'alert alert-danger mb-0 small';
                            alertDiv.innerHTML = `<strong>Incorrect.</strong> Correct answer was ${data.correct_option}. <br> ${data.explanation || ''}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting MCQ:', error);
                        feedback.classList.remove('d-none');
                        alertDiv.className = 'alert alert-danger mb-0 small';
                        alertDiv.innerHTML = '<strong>Error!</strong> Could not submit answer.';
                    });
            });
        });
    });
</script>
{% endblock %}