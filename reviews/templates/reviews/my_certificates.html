{% extends 'core/base_dashboard.html' %}
{% load static %}

{% block title %}My Certificates - Siksha Setu{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-5">
        <div>
            <h1 class="fw-bold display-6 mb-2" style="color: var(--primary-blue);">
                <i class="fas fa-award me-3" style="color: var(--accent-yellow);"></i>My Certificates
            </h1>
            <p class="text-muted mb-0">Your earned achievements and course completions</p>
        </div>
        <div class="mt-3 mt-md-0">
            <span class="badge bg-primary bg-opacity-50 text-primary py-2 px-3 rounded-pill">
                <i class="fas fa-trophy me-2"></i>{{ certificates|length }} Certificate{{ certificates|pluralize }}
            </span>
        </div>
    </div>

    {% if certificates %}
    <!-- Filter/Sort Options -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" class="form-control border-start-0" id="certificateSearch"
                    placeholder="Search certificates by course or instructor...">
            </div>
        </div>
        <div class="col-md-6 mt-2 mt-md-0">
            <div class="d-flex justify-content-md-end">
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort me-2"></i>Sort by: Newest
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-sort="newest">Newest First</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="oldest">Oldest First</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="score">Highest Score</a></li>
                        <li><a class="dropdown-item" href="#" data-sort="title">Course Title</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate Grid -->
    <div class="row g-4" id="certificatesContainer">
        {% for cert in certificates %}
        <div class="col-12 col-md-6 col-lg-4 certificate-card" 
             data-title="{{ cert.course_title|lower }}"
             data-instructor="{{ cert.instructor_name|lower }}" 
             data-date="{{ cert.completion_date|date:'Y-m-d' }}"
             data-score="{{ cert.final_score }}">
            <div class="card border-0 shadow-sm h-100 certificate-hover-card">
                <!-- Certificate Header -->
                <div class="card-header bg-transparent border-0 pb-0 pt-4 px-4">
                    <div class="d-flex align-items-center">
                        <div class="certificate-icon-wrapper">
                            <i class="fas fa-certificate"></i>
                        </div>
                        <div class="ms-3">
                            <div class="badge bg-success bg-opacity-10 text-success mb-1">
                                <i class="fas fa-star me-1"></i>Mastery Achieved
                            </div>
                            <h5 class="fw-bold mb-0 text-truncate" style="color: var(--primary-blue);">
                                {{ cert.course_title }}
                            </h5>
                        </div>
                    </div>
                </div>

                <div class="card-body p-4 pt-3">
                    <!-- Course Details -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-user-graduate text-muted me-2" style="width: 16px;"></i>
                            <small class="text-muted">Instructor</small>
                        </div>
                        <p class="mb-0 fw-semibold">{{ cert.instructor_name }}</p>
                    </div>

                    <!-- Performance Stats -->
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="d-flex flex-column">
                                <small class="text-muted mb-1">Issued Date</small>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-calendar text-primary me-2"></i>
                                    <span class="fw-bold">{{ cert.completion_date|date:"M d, Y" }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex flex-column">
                                <small class="text-muted mb-1">Final Score</small>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                            style="width: {{ cert.final_score }}%"
                                            aria-valuenow="{{ cert.final_score }}" aria-valuemin="0"
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                    <span class="badge bg-success bg-opacity-10 text-success fw-bold">
                                        {{ cert.final_score|floatformat:1 }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certificate ID -->
                    <div class="mb-3 text-center">
                        <small class="text-muted">ID: {{ cert.certificate_id }}</small>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <a href="{% url 'reviews:certificate_download' cert.enrollment.id %}?action=pdf" target="_blank"
                            class="btn btn-primary d-flex align-items-center justify-content-center"
                            style="background: linear-gradient(135deg, var(--primary-purple), #6a11cb); border: none;">
                            <i class="fas fa-file-pdf me-2"></i>Download PDF
                        </a>
                        <button class="btn btn-outline-secondary btn-sm certificate-preview-btn"
                            data-enrollment-id="{{ cert.enrollment.id }}">
                            <i class="fas fa-eye me-2"></i>Quick Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Empty State (Hidden by default) -->
    <div id="noResults" class="text-center py-5 d-none">
        <div class="mb-4">
            <i class="fas fa-search fa-4x text-muted opacity-25"></i>
        </div>
        <h4 class="text-muted mb-3">No Certificates Found</h4>
        <p class="text-muted mb-4">Try adjusting your search criteria</p>
    </div>

    {% else %}
    <!-- Initial Empty State -->
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-award fa-4x text-muted opacity-25"></i>
        </div>
        <h3 class="text-muted mb-3">No Certificates Yet</h3>
        <p class="text-muted mb-4 col-md-6 mx-auto">
            Complete courses with a mastery score of 80% or higher to unlock certificates.
            Your achievements will appear here once you've earned them.
        </p>
        <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
            <a href="{% url 'courses:course_list' %}" class="btn btn-primary px-4">
                <i class="fas fa-book-open me-2"></i>Browse Courses
            </a>
            <a href="{% url 'dashboard:progress' %}" class="btn btn-outline-primary px-4">
                <i class="fas fa-chart-line me-2"></i>View Progress
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Certificate Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0 overflow-hidden d-flex align-items-center justify-content-center" style="background: #0f1c3f; min-height: 450px;">
                <div class="spinner-border text-white" role="status" id="previewSpinner" style="display: none; position: absolute;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <iframe id="certificateFrame" style="width: 505px; height: 355px; border: none; display: block; transform-origin: center center;" 
                    frameborder="0" scrolling="no"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="downloadCertificateBtn" class="btn btn-primary" target="_blank">
                    <i class="fas fa-download me-2"></i>Download Certificate
                </a>
            </div>
        </div>
    </div>
</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="downloadCertificateBtn" class="btn btn-primary" target="_blank">
                    <i class="fas fa-download me-2"></i>Download Certificate
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .certificate-icon-wrapper {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.2));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-yellow);
        font-size: 1.25rem;
    }

    .certificate-hover-card {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .certificate-hover-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1) !important;
        border-color: var(--primary-purple);
    }

    .progress-bar {
        transition: width 1s ease-in-out;
    }

    /* Modal customization */
    .modal-xl {
        max-width: 95%;
    }
    
    @media (min-width: 1200px) {
        .modal-xl {
            max-width: 1200px;
        }
    }

    /* Ensure modal body doesn't scroll */
    .modal-body {
        overflow: hidden !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Search functionality
        const searchInput = document.getElementById('certificateSearch');
        const certificateCards = document.querySelectorAll('.certificate-card');
        const noResults = document.getElementById('noResults');

        if (searchInput) {
            searchInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                let visibleCount = 0;

                certificateCards.forEach(card => {
                    const title = card.dataset.title;
                    const instructor = card.dataset.instructor;

                    if (title.includes(searchTerm) || instructor.includes(searchTerm)) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Show/hide no results message
                if (visibleCount === 0 && searchTerm !== '') {
                    noResults.classList.remove('d-none');
                } else {
                    noResults.classList.add('d-none');
                }
            });
        }

        // Sort functionality
        const sortButtons = document.querySelectorAll('[data-sort]');
        sortButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();
                const sortType = this.dataset.sort;
                const container = document.getElementById('certificatesContainer');
                const cards = Array.from(container.querySelectorAll('.certificate-card'));

                cards.sort((a, b) => {
                    switch (sortType) {
                        case 'newest':
                            return new Date(b.dataset.date) - new Date(a.dataset.date);
                        case 'oldest':
                            return new Date(a.dataset.date) - new Date(b.dataset.date);
                        case 'score':
                            return parseFloat(b.dataset.score) - parseFloat(a.dataset.score);
                        case 'title':
                            return a.dataset.title.localeCompare(b.dataset.title);
                        default:
                            return 0;
                    }
                });

                // Reorder cards
                cards.forEach(card => container.appendChild(card));

                // Update button text
                const dropdownBtn = document.querySelector('.dropdown-toggle');
                if (dropdownBtn) {
                    dropdownBtn.innerHTML = `<i class="fas fa-sort me-2"></i>Sort by: ${this.textContent}`;
                }
            });
        });

        // Preview modal functionality
        const previewBtns = document.querySelectorAll('.certificate-preview-btn');
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        const certificateFrame = document.getElementById('certificateFrame');
        const previewSpinner = document.getElementById('previewSpinner');
        const downloadBtn = document.getElementById('downloadCertificateBtn');
        const previewContainer = document.getElementById('previewContainer');

        // Function to calculate and set iframe scale
        function setIframeScale() {
            if (!certificateFrame.contentDocument) return;
            
            const containerWidth = previewContainer.clientWidth;
            const containerHeight = previewContainer.clientHeight;
            
            // Certificate dimensions in mm (conceptually)
            const certWidth = 297;
            const certHeight = 210;
            
            // Calculate scale to fit in container (with 5% padding)
            const scaleX = (containerWidth * 0.9) / certWidth;
            const scaleY = (containerHeight * 0.9) / certHeight;
            const scale = Math.min(scaleX, scaleY, 0.8); // Max scale 0.8
            
            // Apply scale to iframe
            certificateFrame.style.transform = `scale(${scale})`;
            
            // Set iframe dimensions (original size)
            certificateFrame.style.width = `${certWidth}mm`;
            certificateFrame.style.height = `${certHeight}mm`;
        }

        previewBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const enrollmentId = this.dataset.enrollmentId;
                const baseUrl = `{% url 'reviews:certificate_download' 0 %}`.replace('0', enrollmentId);
                const previewUrl = baseUrl + '?action=preview';
                const downloadUrl = baseUrl + '?action=pdf&auto=1';

                // Show loading spinner
                previewSpinner.style.display = 'inline-block';
                certificateFrame.style.display = 'none';

                // Set iframe source
                certificateFrame.src = previewUrl;

                // Set download link
                downloadBtn.href = downloadUrl;

                // Show modal
                previewModal.show();
            });
        });

        // When iframe loads
        certificateFrame.addEventListener('load', function () {
            previewSpinner.style.display = 'none';
            certificateFrame.style.display = 'block';
            
            // Set scale after iframe loads
            setTimeout(() => {
                setIframeScale();
                
                // Inject preview styles into iframe
                try {
                    const iframeDoc = certificateFrame.contentDocument || certificateFrame.contentWindow.document;
                    if (iframeDoc) {
                        const style = iframeDoc.createElement('style');
                        style.textContent = `
                            body {
                                margin: 0;
                                padding: 0;
                                background: #0d2a2e;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                min-height: 100vh;
                            }
                            .certificate-container {
                                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                            }
                        `;
                        iframeDoc.head.appendChild(style);
                    }
                } catch (e) {
                    console.log('Cannot access iframe content');
                }
            }, 100);
        });

        // Handle iframe load error
        certificateFrame.addEventListener('error', function () {
            previewSpinner.style.display = 'none';
            certificateFrame.style.display = 'block';
            certificateFrame.src = 'about:blank';
            alert('Failed to load certificate preview. Please try again.');
        });

        // Adjust scale on window resize (if modal is open)
        window.addEventListener('resize', function() {
            if (previewModal._isShown) {
                setIframeScale();
            }
        });

        // Adjust scale when modal is shown
        document.getElementById('previewModal').addEventListener('shown.bs.modal', function () {
            if (certificateFrame.style.display !== 'none') {
                setTimeout(setIframeScale, 50);
            }
        });
    });
</script>
{% endblock %}